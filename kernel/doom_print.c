#include <linux/kernel.h>
#include <linux/syscalls.h>

static const char letters[][6][8] = {
   { "  ___   ",
     " / _ \\  ",
     "/ /_\\ \\ ",
     "|  _  | ",
     "| | | | ",
     "\\_| |_/ " },
   { "______  ",
     "| ___ \\ ",
     "| |_/ / ",
     "| ___ \\ ",
     "| |_/ / ",
     "\\____/  " },
   { " _____  ",
     "/  __ \\ ",
     "| /  \\/ ",
     "| |     ",
     "| \\__/\\ ",
     " \\____/ " },
   { "______  ",
     "|  _  \\ ",
     "| | | | ",
     "| | | | ",
     "| |/ /  ",
     "|___/   " },
   { " _____  ",
     "|  ___| ",
     "| |__   ",
     "|  __|  ",
     "| |___  ",
     "\\____/  " },
   { "______  ",
     "|  ___| ",
     "| |_    ",
     "|  _|   ",
     "| |     ",
     "\\_|     " },
   { " _____  ",
     "|  __ \\ ",
     "| |  \\/ ",
     "| | __  ",
     "| |_\\ \\ ",
     " \\____/ " },
   { " _   _  ",
     "| | | | ",
     "| |_| | ",
     "|  _  | ",
     "| | | | ",
     "\\_| |_/ " },
   { " _____  ",
     "|_   _| ",
     "  | |   ",
     "  | |   ",
     " _| |_  ",
     " \\___/  " },
   { "   ___  ",
     "  |_  | ",
     "    | | ",
     "    | | ",
     "/\\__/ / ",
     "\\____/  " },
   { " _   __ ",
     "| | / / ",
     "| |/ /  ",
     "|    \\  ",
     "| |\\  \\ ",
     "\\_| \\_/ " },
   { " _      ",
     "| |     ",
     "| |     ",
     "| |     ",
     "| |____ ",
     "\\_____/ " },
   { "___  ___",
     "|  \\/  |",
     "| .  . |",
     "| |\\/| |",
     "| |  | |",
     "\\_|  |_/" },
   { " _   _  ",
     "| \\ | | ",
     "|  \\| | ",
     "| . ` | ",
     "| |\\  | ",
     "\\_| \\_/ " },
   { " _____  ",
     "|  _  | ",
     "| | | | ",
     "| | | | ",
     "\\ \\_/ / ",
     " \\___/  " },
   { "______  ",
     "| ___ \\ ",
     "| |_/ / ",
     "|  __/  ",
     "| |     ",
     "\\_|     " },
   { " _____  ",
     "|  _  | ",
     "| | | | ",
     "| | | | ",
     "\\ \\/' / ",
     " \\_/\\_\\ " },
   { "______  ",
     "| ___ \\ ",
     "| |_/ / ",
     "|    /  ",
     "| |\\ \\  ",
     "\\_| \\_| " },
   { " _____  ",
     "/  ___| ",
     "\\ `--.  ",
     " `--. \\ ",
     "/\\__/ / ",
     "\\____/  " },
   { " _____  ",
     "|_   _| ",
     "  | |   ",
     "  | |   ",
     "  | |   ",
     "  \\_/   " },
   { " _   _  ",
     "| | | | ",
     "| | | | ",
     "| | | | ",
     "| |_| | ",
     " \\___/  " },
   { " _   _  ",
     "| | | | ",
     "| | | | ",
     "| | | | ",
     "\\ \\_/ / ",
     " \\___/  " },
   { " _    _ ",
     "| |  | |",
     "| |  | |",
     "| |/\\| |",
     "\\  /\\  /",
     " \\/  \\/ " },
   { "__   __ ",
     "\\ \\ / / ",
     " \\ V /  ",
     " /   \\  ",
     "/ /^\\ \\ ",
     "\\/   \\/ " },
   { "__   __ ",
     "\\ \\ / / ",
     " \\ V /  ",
     "  \\ /   ",
     "  | |   ",
     "  \\_/   " },
   { " ______ ",
     "|___  / ",
     "   / /  ",
     "  / /   ",
     "./ /___ ",
     "\\_____/ " },
};

// Converts an ASCII letter into a number from 0 to 26.
static inline int ord(char c) {
    return (c & 0b11111) - 1;
}

// Prints a string with the DOOM font in ASCII art. `msg` must be a string
// composed only of ASCII letters, no spaces or punctuation allowed.
SYSCALL_DEFINE1(doom_print, char __user *, msg) {
    int line;
    int idx;
    int len;
    char *buf;
    int i, j;

    for (len = 0; msg[len]; len++);
    buf = kzalloc(8 * len * sizeof(char), GFP_KERNEL);

    for (line = 0; line < 6; line++) {
        for (i = 0; i < len; i++) {
            idx = ord(msg[i]);
            for (j = 0; j < 8; j++) {
                buf[i * 8 + j] = letters[idx][line][j];
            }
        }
        printk("%.*s\n", 8 * len, buf);
    }

    kfree(buf);
    return 0;
}
